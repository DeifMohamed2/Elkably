<script>
  // Dynamic group options loader
  (function() {
    let centerNames = {};
    let gradeTypeOptions = {};
    let groupTimes = {};

    async function fetchOptions() {
      try {
        const res = await fetch('/teacher/groupOptions');
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Failed to load group options');
        centerNames = data.centerNames || {};
        gradeTypeOptions = data.gradeTypeOptions || {};
        groupTimes = data.groupTimes || {};
        window.__groupOptions = { centerNames, gradeTypeOptions, groupTimes };
      } catch (e) {
        console.error('groupOptions load error:', e);
      }
    }

    function onCenterChange() {
      const centerName = document.getElementById('centerName');
      const Grade = document.getElementById('Grade');
      if (!centerName || !Grade) return;

      const centerVal = centerName.value;
      Grade.innerHTML = '<option value="" selected>Select Grade</option>';
      if (centerNames[centerVal]) {
        centerNames[centerVal].forEach(center => {
          const option = document.createElement('option');
          option.value = center.value;
          option.textContent = center.text;
          Grade.appendChild(option);
        });
      }
      const gradeType = document.getElementById('gradeType');
      if (gradeType) gradeType.innerHTML = '<option value="" selected>Type</option>';
    }

    function onGradeChange() {
      const Grade = document.getElementById('Grade');
      const gradeType = document.getElementById('gradeType');
      if (!Grade || !gradeType) return;

      const selectedGrade = Grade.value;
      gradeType.innerHTML = '<option value="" selected>Type</option>';
      if (gradeTypeOptions[selectedGrade]) {
        gradeTypeOptions[selectedGrade].forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.text;
          gradeType.appendChild(option);
        });
      }
      const groupTime = document.getElementById('groupTime');
      if (groupTime) groupTime.innerHTML = '<option value="" selected>Group Time</option>';
    }

    function updateGroupTimes() {
      const centerName = document.getElementById('centerName');
      const Grade = document.getElementById('Grade');
      const gradeType = document.getElementById('gradeType');
      const groupTime = document.getElementById('groupTime');
      if (!centerName || !Grade || !gradeType || !groupTime) return;

      const selectedCenter = centerName.value;
      const selectedGrade = Grade.value;
      const selectedGradeType = gradeType.value;

      groupTime.innerHTML = '<option value="" selected>Group Time</option>';

      if (!groupTimes[selectedCenter] || !groupTimes[selectedCenter][selectedGrade]) {
        return;
      }
      const times = groupTimes[selectedCenter][selectedGrade][selectedGradeType];
      if (!times || !Array.isArray(times) || times.length === 0) {
        const option = document.createElement('option');
        option.value = 'default';
        option.textContent = 'Default Group Time';
        groupTime.appendChild(option);
        return;
      }
      times.forEach(group => {
        const option = document.createElement('option');
        option.value = group.value;
        option.textContent = group.text;
        groupTime.appendChild(option);
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await fetchOptions();
      const centerNameEl = document.getElementById('centerName');
      const GradeEl = document.getElementById('Grade');
      const gradeTypeEl = document.getElementById('gradeType');
      if (centerNameEl) centerNameEl.addEventListener('change', onCenterChange);
      if (GradeEl) GradeEl.addEventListener('change', onGradeChange);
      if (GradeEl) GradeEl.addEventListener('change', updateGroupTimes);
      if (gradeTypeEl) gradeTypeEl.addEventListener('change', updateGroupTimes);
    });
  })();
</script>